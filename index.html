<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Voice Cloner</title>
    <!-- 1. Load Telegram SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* --- BASE STYLES --- */
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* --- HEADER --- */
        .header {
            padding: 24px 16px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 22px;
            font-weight: 700;
        }
        .header p {
            margin: 8px 0 0;
            color: var(--tg-theme-hint-color, #8e8e93);
            font-size: 15px;
        }

        /* --- GRID LAYOUT --- */
        .grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Two columns */
            gap: 16px;
            padding: 16px;
            padding-bottom: 40px;
        }

        /* --- CELEBRITY CARD --- */
        .celeb-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 16px;
            padding: 20px 10px;
            cursor: pointer;
            transition: transform 0.1s ease;
            position: relative;
        }
        .celeb-card:active {
            transform: scale(0.97); /* Tap effect */
        }
        .celeb-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .celeb-name {
            font-size: 15px;
            font-weight: 600;
            text-align: center;
        }

        /* --- MODAL (POPUP) STYLES --- */
        .modal-overlay {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); /* Dimmed background */
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px); /* Blur effect */
        }

        /* Animation for popup */
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-content {
            background: var(--tg-theme-bg-color, #fff);
            padding: 24px;
            border-radius: 16px;
            width: 85%;
            max-width: 350px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
            animation: slideUp 0.3s ease-out;
            position: relative;
        }

        .modal-title {
            margin: 0 0 10px;
            font-size: 20px;
            font-weight: bold;
        }

        .modal-desc {
            margin: 0 0 20px;
            color: var(--tg-theme-hint-color, #888);
            font-size: 14px;
        }

        /* Text Input Area */
        textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 20px;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid var(--tg-theme-hint-color, #ccc);
            background-color: var(--tg-theme-secondary-bg-color, #f9f9f9);
            color: var(--tg-theme-text-color, #000);
            font-family: inherit;
            font-size: 16px;
            resize: none;
            box-sizing: border-box;
            outline: none;
        }
        textarea:focus {
            border-color: var(--tg-theme-button-color, #3390ec);
        }

        /* Buttons */
        .btn-primary {
            background-color: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #fff);
            border: none;
            padding: 14px;
            border-radius: 10px;
            width: 100%;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .btn-primary:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: transparent;
            color: var(--tg-theme-hint-color, #888);
            border: none;
            padding: 10px;
            width: 100%;
            font-size: 14px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <!-- HEADER -->
    <div class="header">
        <h1>Voice Cloner AI</h1>
        <p>Tap a celebrity to create a video.</p>
    </div>

    <!-- GRID OF CELEBRITIES -->
    <div class="grid-container">
        
        <!-- CARD 1: Morgan Freeman -->
        <!-- Replace 'src' with your own image URLs later -->
        <div class="celeb-card" onclick="openModal('morgan_freeman_1', 'Morgan Freeman')">
            <img src="https://placehold.co/200x200/333/FFF?text=MF" alt="Morgan" class="celeb-icon">
            <span class="celeb-name">Morgan Freeman</span>
        </div>

        <!-- CARD 2: Taylor Swift -->
        <div class="celeb-card" onclick="openModal('taylor_swift_1', 'Taylor Swift')">
            <img src="https://placehold.co/200x200/ff69b4/FFF?text=TS" alt="Taylor" class="celeb-icon">
            <span class="celeb-name">Taylor Swift</span>
        </div>

        <!-- CARD 3: Elon Musk -->
        <div class="celeb-card" onclick="openModal('elon_musk_1', 'Elon Musk')">
            <img src="https://placehold.co/200x200/cc0000/FFF?text=EM" alt="Elon" class="celeb-icon">
            <span class="celeb-name">Elon Musk</span>
        </div>

        <!-- CARD 4: Barack Obama -->
        <div class="celeb-card" onclick="openModal('barack_obama_1', 'Barack Obama')">
            <img src="https://placehold.co/200x200/0000cc/FFF?text=BO" alt="Obama" class="celeb-icon">
            <span class="celeb-name">Barack Obama</span>
        </div>

    </div>

    <!-- MODAL POPUP (Hidden by default) -->
    <div id="inputModal" class="modal-overlay" onclick="closeModalOnOutsideClick(event)">
        <div class="modal-content">
            <h3 class="modal-title" id="modalTitle">Voice Name</h3>
            <p class="modal-desc">Type the text you want them to speak.</p>

            <textarea id="userText" placeholder="Hello, this is a test message..."></textarea>

            <button id="generateBtn" class="btn-primary" onclick="submitToN8n()">Generate Video</button>
            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
        </div>
    </div>

    <script>
        // 1. Initialize Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.expand(); // Make it full height

        // Variables to hold current selection
        let currentVoiceId = null;
        let currentVoiceName = null;

        // --- FUNCTIONS ---

        // Open the modal
        function openModal(id, name) {
            currentVoiceId = id;
            currentVoiceName = name;

            // Update UI text
            document.getElementById('modalTitle').innerText = name;
            document.getElementById('userText').value = ""; // Clear old text
            
            // Show modal
            document.getElementById('inputModal').style.display = 'flex';
            
            // Focus input (improves UX)
            setTimeout(() => {
                document.getElementById('userText').focus();
            }, 100);
        }

        // Close the modal
        function closeModal() {
            document.getElementById('inputModal').style.display = 'none';
        }

        // Close if user clicks the dark background
        function closeModalOnOutsideClick(event) {
            if (event.target.id === 'inputModal') {
                closeModal();
            }
        }

        // --- SUBMIT TO N8N ---
        function submitToN8n() {
            const text = document.getElementById('userText').value;

            // Validation
            if (!text || text.trim() === "") {
                tg.showAlert("Please enter some text!");
                return;
            }

            // Disable button to prevent double clicks
            const btn = document.getElementById('generateBtn');
            btn.innerText = "Sending...";
            btn.disabled = true;

            // PREPARE DATA
            const payload = {
                voice_id: currentVoiceId,
                voice_name: currentVoiceName,
                text: text,
                // Critical: Send user info so n8n knows who to reply to
                user_id: tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : "unknown",
                first_name: tg.initDataUnsafe.user ? tg.initDataUnsafe.user.first_name : "User",
                initData: tg.initData // For security validation
            };

            // YOUR N8N WEBHOOK URL HERE
            // Note: Use your ngrok URL for testing, or production URL later
            const webhookUrl = "https://primary-production-eb80.up.railway.app/webhook-test/4b0fe177-57c6-4e97-a3f4-a976f61a8046"; 

            // SEND REQUEST
            fetch(webhookUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(response => {
                // n8n received it successfully
                btn.innerText = "Sent!";
                
                // UX: Close app after short delay so they see "Sent!"
                setTimeout(() => {
                    closeModal();
                    // Optional: Show alert before closing
                    // tg.showAlert("Processing! I'll send the video in the chat.");
                    tg.close(); 
                }, 500);
            })
            .catch(error => {
                // Handle Error
                tg.showAlert("Error connecting to server. Check your internet.");
                console.error(error);
                btn.innerText = "Generate Video";
                btn.disabled = false;
            });
        }
    </script>
</body>
</html>